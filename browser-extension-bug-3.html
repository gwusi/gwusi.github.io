<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Dropdown Cascade Test - Browser Extension Interference Demo (Standalone)</title>
    <style type="text/css">
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .field-row { 
            margin: 15px 0; 
            display: flex;
            align-items: center;
        }
        .field-label { 
            display: inline-block; 
            width: 120px; 
            font-weight: bold; 
            margin-right: 10px;
        }
        .dropdown { 
            width: 250px; 
            padding: 8px; 
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .dropdown:disabled {
            background-color: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        .info-panel { 
            background-color: #f0f8ff; 
            border: 1px solid #0066cc; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 4px;
        }
        .event-log { 
            background-color: #f9f9f9; 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 250px; 
            overflow-y: scroll; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .instructions { 
            background-color: #fff3cd; 
            border: 1px solid #ffeaa7; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 4px;
        }
        .button {
            background-color: #007cba;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        .button:hover {
            background-color: #005a87;
        }
        .loading {
            display: none;
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }
        .status-enabled { background-color: #28a745; }
        .status-disabled { background-color: #dc3545; }
        .status-loading { 
            background-color: #ffc107; 
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dropdown Cascade Test Demo (Standalone)</h1>
        
        <div class="instructions">
            <h3>Testing for Browser Extension Interference</h3>
            <p><strong>Purpose:</strong> This standalone page simulates the same dropdown cascade functionality as ASP.NET time entry pages.</p>
            <p><strong>How to test:</strong></p>
            <ol>
                <li>Select a "Client" from the first dropdown</li>
                <li>Wait for simulated async loading - "Plan" dropdown should populate</li>
                <li>Select a "Plan" - "Engagement" dropdown should populate after a delay</li>
                <li>Select an "Engagement" - "Job" dropdown should populate after a delay</li>
            </ol>
            <p><strong>If browser extensions are interfering:</strong> The cascade may stop working, events may not fire, or dropdowns may not populate.</p>
            <p><strong>Note:</strong> This simulates the AutoPostBack behavior and asynchronous data loading of the original ASP.NET application.</p>
        </div>

        <div class="field-row">
            <span class="field-label">Client:</span>
            <select id="ddlClient" class="dropdown">
                <option value="">-- Select Client --</option>
                <option value="1234567">ABC Corporation (1234567)</option>
                <option value="2345678">XYZ Company (2345678)</option>
                <option value="3456789">Test Client Inc (3456789)</option>
                <option value="9999999">Demo Client LLC (9999999)</option>
            </select>
            <span class="status-indicator status-enabled" id="statusClient"></span>
            <span class="loading" id="loadingClient">Loading plans...</span>
        </div>

        <div class="field-row">
            <span class="field-label">Plan:</span>
            <select id="ddlPlan" class="dropdown" disabled>
                <option value="">-- Select Plan --</option>
            </select>
            <span class="status-indicator status-disabled" id="statusPlan"></span>
            <span class="loading" id="loadingPlan">Loading engagements...</span>
        </div>

        <div class="field-row">
            <span class="field-label">Engagement:</span>
            <select id="ddlEngagement" class="dropdown" disabled>
                <option value="">-- Select Engagement --</option>
            </select>
            <span class="status-indicator status-disabled" id="statusEngagement"></span>
            <span class="loading" id="loadingEngagement">Loading jobs...</span>
        </div>

        <div class="field-row">
            <span class="field-label">Job:</span>
            <select id="ddlJob" class="dropdown" disabled>
                <option value="">-- Select Job --</option>
            </select>
            <span class="status-indicator status-disabled" id="statusJob"></span>
        </div>

        <div class="info-panel">
            <h4>Current Selections:</h4>
            <p><strong>Client:</strong> <span id="lblSelectedClient">None</span></p>
            <p><strong>Plan:</strong> <span id="lblSelectedPlan">None</span></p>
            <p><strong>Engagement:</strong> <span id="lblSelectedEngagement">None</span></p>
            <p><strong>Job:</strong> <span id="lblSelectedJob">None</span></p>
            <p><strong>Last Event:</strong> <span id="lblLastEvent">None</span></p>
            <p><strong>Event Time:</strong> <span id="lblEventTime">None</span></p>
        </div>

        <div class="field-row">
            <h4>Event Log:</h4>
            <div class="event-log" id="eventLog"></div>
        </div>

        <div class="field-row">
            <button class="button" onclick="resetAllDropdowns()">Reset All Dropdowns</button>
            <button class="button" onclick="clearEventLog()">Clear Event Log</button>
            <button class="button" onclick="simulateInterference()">Simulate Extension Interference</button>
            <button class="button" onclick="restoreNormalBehavior()">Restore Normal Behavior</button>
        </div>
    </div>

    <script type="text/javascript">
        // Global state
        let eventLog = [];
        let isInterferenceActive = false;
        let eventHandlersBlocked = false;

        // Data structures to simulate backend data
        const clientData = {
            '1234567': {
                name: 'ABC Corporation (1234567)',
                plans: {
                    '101': 'Plan A - Audit Services (101)',
                    '102': 'Plan B - Tax Services (102)',
                    '103': 'Plan C - Consulting (103)'
                }
            },
            '2345678': {
                name: 'XYZ Company (2345678)',
                plans: {
                    '201': 'Plan X - Annual Review (201)',
                    '202': 'Plan Y - Quarterly Review (202)'
                }
            },
            '3456789': {
                name: 'Test Client Inc (3456789)',
                plans: {
                    '301': 'Plan Test1 - Development (301)',
                    '302': 'Plan Test2 - Testing (302)',
                    '303': 'Plan Test3 - Maintenance (303)'
                }
            },
            '9999999': {
                name: 'Demo Client LLC (9999999)',
                plans: {
                    '401': 'Demo Plan Alpha (401)',
                    '402': 'Demo Plan Beta (402)'
                }
            }
        };

        const engagementData = {
            '101': { 'E001': 'Engagement 2024-Q1 (E001)', 'E002': 'Engagement 2024-Q2 (E002)', 'E003': 'Engagement 2024-Q3 (E003)' },
            '102': { 'E001': 'Engagement 2024-Q1 (E001)', 'E002': 'Engagement 2024-Q2 (E002)', 'E003': 'Engagement 2024-Q3 (E003)' },
            '103': { 'E001': 'Engagement 2024-Q1 (E001)', 'E002': 'Engagement 2024-Q2 (E002)', 'E003': 'Engagement 2024-Q3 (E003)' },
            '201': { 'E101': 'Annual Engagement (E101)', 'E102': 'Special Project (E102)' },
            '202': { 'E101': 'Annual Engagement (E101)', 'E102': 'Special Project (E102)' },
            '301': { 'E201': 'Phase 1 Development (E201)', 'E202': 'Phase 2 Testing (E202)', 'E203': 'Phase 3 Deployment (E203)' },
            '302': { 'E201': 'Phase 1 Development (E201)', 'E202': 'Phase 2 Testing (E202)', 'E203': 'Phase 3 Deployment (E203)' },
            '303': { 'E201': 'Phase 1 Development (E201)', 'E202': 'Phase 2 Testing (E202)', 'E203': 'Phase 3 Deployment (E203)' },
            '401': { 'E301': 'Demo Engagement Alpha (E301)', 'E302': 'Demo Engagement Beta (E302)' },
            '402': { 'E301': 'Demo Engagement Alpha (E301)', 'E302': 'Demo Engagement Beta (E302)' }
        };

        const jobData = {
            'default': {
                '100': '100 - Planning',
                '200': '200 - Fieldwork',
                '300': '300 - Review',
                '400': '400 - Documentation',
                '500': '500 - Client Communication',
                '600': '600 - Administrative'
            },
            'audit': {
                '710': '710 - Audit Procedures',
                '720': '720 - Testing Controls'
            },
            'development': {
                '810': '810 - Development Work',
                '820': '820 - Code Review'
            },
            'demo': {
                '910': '910 - Demo Preparation',
                '920': '920 - Training'
            }
        };

        // Utility functions
        function logEvent(message) {
            const timestamp = new Date().toLocaleTimeString() + '.' + new Date().getMilliseconds().toString().padStart(3, '0');
            const logEntry = `[${timestamp}] ${message}`;
            eventLog.push(logEntry);
            updateEventLogDisplay();
            console.log('[DropdownDemo] ' + logEntry);
        }

        function updateEventLogDisplay() {
            document.getElementById('eventLog').textContent = eventLog.join('\n');
            document.getElementById('eventLog').scrollTop = document.getElementById('eventLog').scrollHeight;
        }

        function updateSelectionDisplay(type, value) {
            document.getElementById(`lblSelected${type}`).textContent = value || 'None';
            document.getElementById('lblLastEvent').textContent = `${type} selection changed`;
            document.getElementById('lblEventTime').textContent = new Date().toLocaleTimeString();
        }

        function setDropdownStatus(dropdownId, enabled) {
            const dropdown = document.getElementById(dropdownId);
            const statusId = dropdownId.replace('ddl', 'status');
            const status = document.getElementById(statusId);
            
            dropdown.disabled = !enabled;
            status.className = `status-indicator ${enabled ? 'status-enabled' : 'status-disabled'}`;
        }

        function showLoading(dropdownType, show) {
            const loading = document.getElementById(`loading${dropdownType}`);
            const statusId = `status${dropdownType}`;
            const status = document.getElementById(statusId);
            
            if (show) {
                loading.style.display = 'inline';
                status.className = 'status-indicator status-loading';
            } else {
                loading.style.display = 'none';
                status.className = `status-indicator ${document.getElementById(`ddl${dropdownType}`).disabled ? 'status-disabled' : 'status-enabled'}`;
            }
        }

        function populateDropdown(dropdownId, data, defaultText) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = `<option value="">${defaultText}</option>`;
            
            for (const [value, text] of Object.entries(data)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                dropdown.appendChild(option);
            }
        }

        function clearDropdown(dropdownId, defaultText) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = `<option value="">${defaultText}</option>`;
            dropdown.selectedIndex = 0;
        }

        // Simulate async operations like ASP.NET AutoPostBack
        function simulateAsyncOperation(operation, delay = 500) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (!eventHandlersBlocked) {
                        operation();
                    } else {
                        logEvent('Event handler blocked by simulated interference!');
                    }
                    resolve();
                }, delay);
            });
        }

        // Event handlers
        async function handleClientChange() {
            if (eventHandlersBlocked) {
                logEvent('Client change event blocked by interference');
                return;
            }

            const clientSelect = document.getElementById('ddlClient');
            const selectedValue = clientSelect.value;
            const selectedText = clientSelect.options[clientSelect.selectedIndex].text;
            
            logEvent(`Client dropdown changed to: ${selectedValue}`);
            updateSelectionDisplay('Client', selectedText);

            // Reset dependent dropdowns
            clearDropdown('ddlPlan', '-- Select Plan --');
            clearDropdown('ddlEngagement', '-- Select Engagement --');
            clearDropdown('ddlJob', '-- Select Job --');
            
            updateSelectionDisplay('Plan', '');
            updateSelectionDisplay('Engagement', '');
            updateSelectionDisplay('Job', '');

            setDropdownStatus('ddlPlan', false);
            setDropdownStatus('ddlEngagement', false);
            setDropdownStatus('ddlJob', false);

            if (selectedValue) {
                showLoading('Plan', true);
                logEvent('Starting async plan loading...');
                
                await simulateAsyncOperation(() => {
                    const plans = clientData[selectedValue].plans;
                    populateDropdown('ddlPlan', plans, '-- Select Plan --');
                    setDropdownStatus('ddlPlan', true);
                    logEvent(`Plan dropdown enabled and populated for client ${selectedValue}`);
                }, 750); // Simulate network delay
                
                showLoading('Plan', false);
            } else {
                logEvent('Plan dropdown disabled (no client selected)');
            }
        }

        async function handlePlanChange() {
            if (eventHandlersBlocked) {
                logEvent('Plan change event blocked by interference');
                return;
            }

            const planSelect = document.getElementById('ddlPlan');
            const selectedValue = planSelect.value;
            const selectedText = planSelect.options[planSelect.selectedIndex].text;
            
            logEvent(`Plan dropdown changed to: ${selectedValue}`);
            updateSelectionDisplay('Plan', selectedText);

            // Reset dependent dropdowns
            clearDropdown('ddlEngagement', '-- Select Engagement --');
            clearDropdown('ddlJob', '-- Select Job --');
            
            updateSelectionDisplay('Engagement', '');
            updateSelectionDisplay('Job', '');

            setDropdownStatus('ddlEngagement', false);
            setDropdownStatus('ddlJob', false);

            if (selectedValue) {
                showLoading('Engagement', true);
                logEvent('Starting async engagement loading...');
                
                await simulateAsyncOperation(() => {
                    const engagements = engagementData[selectedValue];
                    populateDropdown('ddlEngagement', engagements, '-- Select Engagement --');
                    setDropdownStatus('ddlEngagement', true);
                    logEvent(`Engagement dropdown enabled and populated for plan ${selectedValue}`);
                }, 600);
                
                showLoading('Engagement', false);
            } else {
                logEvent('Engagement dropdown disabled (no plan selected)');
            }
        }

        async function handleEngagementChange() {
            if (eventHandlersBlocked) {
                logEvent('Engagement change event blocked by interference');
                return;
            }

            const engagementSelect = document.getElementById('ddlEngagement');
            const selectedValue = engagementSelect.value;
            const selectedText = engagementSelect.options[engagementSelect.selectedIndex].text;
            
            logEvent(`Engagement dropdown changed to: ${selectedValue}`);
            updateSelectionDisplay('Engagement', selectedText);

            // Reset dependent dropdown
            clearDropdown('ddlJob', '-- Select Job --');
            updateSelectionDisplay('Job', '');
            setDropdownStatus('ddlJob', false);

            if (selectedValue) {
                showLoading('Job', true);
                logEvent('Starting async job loading...');
                
                await simulateAsyncOperation(() => {
                    let jobs = { ...jobData.default };
                    
                    // Add specific jobs based on engagement type
                    if (selectedValue.startsWith('E1')) {
                        jobs = { ...jobs, ...jobData.audit };
                    } else if (selectedValue.startsWith('E2')) {
                        jobs = { ...jobs, ...jobData.development };
                    } else if (selectedValue.startsWith('E3')) {
                        jobs = { ...jobs, ...jobData.demo };
                    }
                    
                    populateDropdown('ddlJob', jobs, '-- Select Job --');
                    setDropdownStatus('ddlJob', true);
                    logEvent(`Job dropdown enabled and populated for engagement ${selectedValue}`);
                }, 400);
                
                showLoading('Job', false);
            } else {
                logEvent('Job dropdown disabled (no engagement selected)');
            }
        }

        function handleJobChange() {
            if (eventHandlersBlocked) {
                logEvent('Job change event blocked by interference');
                return;
            }

            const jobSelect = document.getElementById('ddlJob');
            const selectedText = jobSelect.options[jobSelect.selectedIndex].text;
            
            logEvent(`Job dropdown changed to: ${jobSelect.value}`);
            updateSelectionDisplay('Job', selectedText);
        }

        // Utility functions for testing
        function resetAllDropdowns() {
            logEvent('Reset button clicked - clearing all selections');
            
            document.getElementById('ddlClient').selectedIndex = 0;
            clearDropdown('ddlPlan', '-- Select Plan --');
            clearDropdown('ddlEngagement', '-- Select Engagement --');
            clearDropdown('ddlJob', '-- Select Job --');
            
            updateSelectionDisplay('Client', '');
            updateSelectionDisplay('Plan', '');
            updateSelectionDisplay('Engagement', '');
            updateSelectionDisplay('Job', '');
            
            setDropdownStatus('ddlPlan', false);
            setDropdownStatus('ddlEngagement', false);
            setDropdownStatus('ddlJob', false);
            
            document.getElementById('lblLastEvent').textContent = 'Reset';
            document.getElementById('lblEventTime').textContent = new Date().toLocaleTimeString();
        }

        function clearEventLog() {
            eventLog = [];
            updateEventLogDisplay();
        }

        function simulateInterference() {
            isInterferenceActive = true;
            eventHandlersBlocked = true;
            logEvent('*** SIMULATING BROWSER EXTENSION INTERFERENCE ***');
            logEvent('Event handlers are now blocked - dropdown cascade should fail');
        }

        function restoreNormalBehavior() {
            isInterferenceActive = false;
            eventHandlersBlocked = false;
            logEvent('*** INTERFERENCE REMOVED - NORMAL BEHAVIOR RESTORED ***');
            logEvent('Event handlers are now working - dropdown cascade should function normally');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            logEvent('Page loaded - initializing dropdown event handlers');
            
            // Attach event listeners
            document.getElementById('ddlClient').addEventListener('change', handleClientChange);
            document.getElementById('ddlPlan').addEventListener('change', handlePlanChange);
            document.getElementById('ddlEngagement').addEventListener('change', handleEngagementChange);
            document.getElementById('ddlJob').addEventListener('change', handleJobChange);
            
            logEvent('Event handlers attached successfully');
            
            // Monitor for potential interference
            let changeEventCount = 0;
            setInterval(() => {
                const previousCount = changeEventCount;
                // This would detect if events are firing but not being processed
                // In a real scenario, browser extensions might block event handlers
            }, 1000);
        });

        // Detect if events are being prevented
        ['ddlClient', 'ddlPlan', 'ddlEngagement', 'ddlJob'].forEach(id => {
            document.addEventListener('DOMContentLoaded', function() {
                const element = document.getElementById(id);
                element.addEventListener('change', function(e) {
                    logEvent(`Native change event detected on ${id}`);
                }, true); // Use capture phase to detect early
            });
        });
    </script>
</body>
</html>
